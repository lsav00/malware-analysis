#everything gets deduplicated at regex, but have to create good source with WireShark
#deduplicate by dns info 

import os
import subprocess
import time
import re
import csv


tshark_loc = os.path.join("C:\\", "Program Files", "Wireshark")
os.chdir(tshark_loc)

#the actual command
tsharkcmd1 = "tshark" 
tsharkcmd1 += " -r c:\\users\\savid\\desktop\\malware_analysis\\homies2.pcap"

#the command
with open("C:\\users\\savid\\Desktop\\malware_analysis\\output4.txt", "w") as stdout:
	subprocess.Popen(tsharkcmd1, shell=True, stdout=stdout, stderr=stdout)


	
time.sleep(1)

filename = os.path.join("C:\\", "Users", "savid", "Desktop", "malware_analysis", "output4.txt")
file = open(filename, "r")
#for line in file:
#	print(line)


ip_list=[]
new_list=[]
for line in file:
	#input(line)
	line=line.replace(" " ,",")
	new_list.append(line) #captures all lines in csv format
	test = re.findall("\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}", line) #puts IPs into "test"
	for t in test:
		#print(t)
		if t not in ip_list:
			ip_list.append(t) #appends IPs to "ip_list"
		#print("ip_list:", ip_list)

ip_list.sort()
dns_list1=[]
print("number of unique IPs: ", len(ip_list))
print("Excluding 192.168.*")
for x in ip_list:
	y=x[:8]
	if (y !="192.168.") and x not in dns_list1:
		dns_list1.append(x)
for nslookup in dns_list1:
	nslookup= "nslookup " + nslookup
	os.system(nslookup)
	
	